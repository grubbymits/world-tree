<!DOCTYPE html>
<html>
<head>
  <meta content="text/html;charset=utf-8" http-equiv="Content-Type">
  <title>Small Island Demo</title>
</head>
<body>
  <div>
    <canvas id="demoCanvas" oncontextmenu="return false;" width="1280" height="720">
  </div>
  <script type="module">
    import * as WT from "../../dist/world-tree.js";

    // Sprite sheet layout
    // flat: rock, grass/rock, dry grass/sand, wet grass/sand, muddy grass/sand, sand, water
    // ramps: (south, west, east, north)
    //  - rock
    //  - grass/rock
    //  - grass/sand
    const sheet = new WT.SpriteSheet("../../../res/img/basic-outside");
    const spriteWidth = 322;
    const spriteHeight = 270;
    function addGraphic(type, shape, offsetX, offsetY) {
      WT.Terrain.addGraphic(type, shape, sheet, offsetX, offsetY, spriteWidth, spriteHeight);
    }

    addGraphic(WT.TerrainType.Rock, WT.TerrainShape.Flat, 0, 0);
    addGraphic(WT.TerrainType.DryGrass, WT.TerrainShape.Flat, spriteWidth * 2, 0);
    addGraphic(WT.TerrainType.Sand, WT.TerrainShape.Flat, spriteWidth * 5, 0);
    addGraphic(WT.TerrainType.Water, WT.TerrainShape.Flat, spriteWidth * 6, 0);

    const rampOffsetY = 3 * spriteHeight;
    const rampShapes = [ WT.TerrainShape.RampUpSouth,
                         WT.TerrainShape.RampUpWest,
                         WT.TerrainShape.RampUpEast,
                         WT.TerrainShape.RampUpNorth ];
    for (let i in rampShapes) {
      addGraphic(WT.TerrainType.DryGrass, rampShapes[i], i * spriteWidth, rampOffsetY);
    }

    const cellsX = 9;
    const cellsY = 9;
    const numTerraces = 1;
    let heightMap = [ [ 0, 0, 0, 0, 0, 0, 0, 0, 0 ],
                      [ 0, 1, 1, 1, 1, 1, 1, 1, 0 ],
                      [ 0, 1, 1, 1, 1, 1, 1, 1, 0 ],
                      [ 0, 1, 1, 2, 2, 2, 1, 1, 0 ],
                      [ 0, 1, 1, 2, 2, 2, 1, 1, 0 ],
                      [ 0, 1, 1, 1, 2, 2, 2, 1, 0 ],
                      [ 0, 1, 1, 1, 1, 2, 2, 1, 0 ],
                      [ 0, 1, 1, 1, 1, 1, 1, 1, 0 ],
                      [ 0, 0, 0, 0, 0, 0, 0, 0, 0] ];

    window.onload = (event) => {
      console.log("window loaded");
      const physicalDims =
        WT.TwoByOneIsometric.getDimensions(spriteWidth, spriteHeight);
      const worldDims = new WT.Dimensions(physicalDims.width * cellsX,
                                          physicalDims.depth * cellsY,
                                          physicalDims.height * (1 + numTerraces));
      let canvas = document.getElementById("demoCanvas");
      let context = new WT.Context(worldDims);
      context.addRenderer(canvas,
                          WT.Perspective.TwoByOneIsometric);
    
      let config = new WT.TerrainBuilderConfig(numTerraces,
                                               WT.TerrainType.DryGrass,
                                               WT.TerrainType.DryGrass);
      config.hasWater = true;
      config.hasBiomes = true;
      config.hasRamps = true;
      // Use the height map to construct a terrain.
      let builder = new WT.TerrainBuilder(cellsX, cellsY, heightMap,
                                          config, physicalDims);
      builder.generateMap(context);
      let camera = new WT.MouseCamera(context.scene, canvas,
                                      canvas.width, canvas.height);
    
      var update = function update() {
        if (document.hasFocus()) {
          context.update(camera);
        }
        window.requestAnimationFrame(update);
      }
      window.requestAnimationFrame(update);
    }
  </script>
</body>
</html>
